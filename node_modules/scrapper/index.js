'use strict';

//cleanArray removes all duplicated elements
function cleanArray(array) {
  var i, j, len = array.length, out = [], obj = {};
  for (i = 0; i < len; i++) {
    obj[array[i]] = 0;
  }
  for (j in obj) {
    out.push(j);
  }
  return out;
}

//on recup le fichier contenant les param de config de recherche
var searchConfig= require('../../searchConfig.json');


var test = function(){
  autoScoutResponse(searchConfig.annee,searchConfig.kilometrageMax);


}

var autoScoutInfoItem= function(link){
  var phantomb = require('phantom');
  var infoItem ={};

  var sitepage = null;
  var phInstanceit = null;


  phantomb.create()
  .then(instance => {
    phInstanceit = instance;

    return instance.createPage();
  })
  .then(page => {
    sitepage = page;
    return page.open(link);
  })
  .then(status => {
    return sitepage.property('content');

  })
  .then(content => {
//    http://fr.ww3.autoscout24.be/classified/296956068?asrc=st|as

    infoItem.url= link;
    infoItem.ref='AS_'+link.replace('http://fr.ww3.autoscout24.be/classified/','').replace('?asrc=st|as','')
    infoItem.site= 'Autoscout24';
    /<h1 class="fontHeadline" data\-test="headline" ng\-non\-bindable="">(.+)<\/h1>/.exec(content)
    infoItem.info=RegExp.$1;
    infoItem.marque=infoItem.info.split(" ")[0];
    infoItem.typeOfCar=infoItem.info.replace(infoItem.marque+" ","");

    infoItem.km =content.match(/<div>[0-9\.]+ km<\/div>/g);
    infoItem.km=infoItem.km[0];
    infoItem.km=infoItem.km.replace ('<div>',"").replace ('</div>',"").replace (' ',"").replace ('km',"").replace ('.',"");
    infoItem.km=parseInt(infoItem.km.replace ('.',""));

    /<div class="fontHeadlineLCorporate"> € (.+),\-<\/div>/.exec(content)
    infoItem.price=parseInt(RegExp.$1.replace('.',''));

    /<div>[0-3]{1}[0-9]{1}\/([0-9]{4})<\/div>/.exec(content)
    infoItem.year=parseInt(RegExp.$1);

    /<div>.+ kW \((.+) CH\)<\/div>/.exec(content)
    infoItem.power=parseInt(RegExp.$1);

    // /<div class="gridWidth3 propertyWithBreaks" id="allfueltypesRow">\n<span>(.+)<\/span>\n<\/div>/.exec(content)
    // infoItem.fuel=RegExp.$1;

    /<span data\-test="phoneNumbers">(.+)<\/span>/.exec(content)
    infoItem.phone=RegExp.$1;

    /<span data\-test="zipCode">(.+)<\/span>/.exec(content)
    infoItem.cp=RegExp.$1;

    /<span data\-test="city">(.+)<\/span>/.exec(content)
    infoItem.city=RegExp.$1;


    sitepage.close();
    phInstanceit.exit(function (){
return infoItem;

    });

  })
  .catch(error => {
      //console.log(error);
      return infoItem;
      phInstanceit.exit();
  });


}



var autoScoutResponse = function(annee, kilometrage){

  var phantom = require('phantom');
  var tabloReponse= [];
  var sitepage = null;
  var phInstance = null;


  phantom.create()
  .then(instance => {
    phInstance = instance;
    return instance.createPage();
  })
  .then(page => {
    sitepage = page;
    return page.open('http://vehicules.autoscout24.be/?atype=C&fregfrom='+annee+'&kmto='+kilometrage+'&cy=B&ustate=N,U&custtype=P&sort=age&desc=1&results=80&page=1&event=sort&dtr=s');
    //http://vehicules.autoscout24.be/?atype=C&fregfrom=2008&kmto=150000&cy=B&ustate=N,U&custtype=P&sort=age&desc=1&results=80&page=1&event=sort&dtr=s
  })
  .then(status => {
    //console.log(status);
    return sitepage.property('content');
  })

  .then(content => {
    var tab=content.match(/http:\/\/fr\.ww3\.autoscout24\.be\/classified\/[0-9]{9}\?asrc=st\|as/g);
    tab=cleanArray(tab);


    //on recherche maintenant sur tt les liens de la pagetab.length
    for (var i=0;i<3; i++){
      tabloReponse.push(autoScoutInfoItem(tab[i]));

    }

    console.log(tab[0]);
        console.log(tabloReponse);




    sitepage.close();
    phInstance.exit();
  })
  .catch(error => {
    //  console.log(error);
    phInstance.exit();
  });


}



var goCarResponse = function (annee, kilometrage){
  var listegocar=[];
  var osmosis= require('../osmosis');

  osmosis.get('http://gocar.be/fr/autovlan/voiture-occasion/toutes-marques/tous-modele/page1?country=be&sort=upsellOnTop%3ADESC||days_in_stock%3ADESC&ctype=1&manufacturer=&model=&searchstring=&build=&zip=&radius=500&warranty_program=&mkey=G1-21203-895645&dkey=&_qualityLabel=&km_from=101&km_to='+kilometrage+'&reg_date_from=&reg_date_to='+annee+'&price_from=&price_to=&gas=&kw_from=&kw_to=&_hp_from=&_hp_to=&gears=&doors_grouped=&seats=&euronorm=&age=&private_ad=1&_private_ad=1&color=&accident=')
  .find('.item-vehicle__description a:first-child')
  .follow('@href')
  .set({prix:'body > div.root-a > section > article > div.page_vehicle-details_main_body > div.info > div:nth-child(1) > div.cost > div',
  nom:'.page_vehicle-details_main_head h2',
  couleur:'body > div.root-a > section > div:nth-child(5) > section > article > div:nth-child(1) > ul > li:nth-child(7) > span',
  kilometrage:'body > div.root-a > section > article > div.page_vehicle-details_main_body > div.info > div:nth-child(2) > div.basics > ul > li:nth-child(3) > span:nth-child(2)',
  annee:'body > div.root-a > section > article > div.page_vehicle-details_main_body > div.info > div:nth-child(2) > div.basics > ul > li:nth-child(4) > span:nth-child(2)',
  carburant:'body > div.root-a > section > article > div.page_vehicle-details_main_body > div.info > div:nth-child(2) > div.basics > ul > li:nth-child(1) > span:nth-child(2)',
  categorie:'body > div.root-a > section > div:nth-child(5) > section > article > div:nth-child(1) > ul > li:nth-child(1) > span',
  puissance:'body > div.root-a > section > div:nth-child(5) > section > article > div:nth-child(1) > ul > li:nth-child(2) > span',
  porte:'body > div.root-a > section > div:nth-child(5) > section > article > div:nth-child(1) > ul > li:nth-child(4) > span',
  dateannonce:'body > div.root-a > section > article>div:nth-child(1)',
  phone:'body > div.root-a > section > div:nth-child(5) > section > article > div.box_seller-details > div > div > p.showtel > span > img @data-src',
  ville:'body > div.root-a > section > article > div.page_vehicle-details_main_body > div.info > div:nth-child(2) > div.seller > div > p:nth-child(2) > span:nth-child(2)',
  codepostal:'body > div.root-a > section > article > div.page_vehicle-details_main_body > div.info > div:nth-child(2) > div.seller > div > p:nth-child(2) > span:nth-child(1)',
  equipement:'body > div.root-a > section > div:nth-child(5) > section > article > div:nth-child(2) > ul'})
  .then (function(context,data, next) {
    data.type="";
    for(var j=2; j<data.nom.split(" ").length; j++){
      //         data.type=data.type+data.nom.split(" ")[j]+" "
    };
    data.phone ="http://gocar.be"+data.phone;
    //  data.url= document.request.url;
    //   console.log(data.url);
    data.marque=data.nom.split(" ")[1];
    data.url = context.doc().requesthref;
    data.eqx
    //Comme tu peux le voir, si tu enleve le quote, les data sont bien récupére donc ca marche
    //   console.log(data);
    listegocar.push(data);
    next(context, data);


  }).then (function(context,data, next) {

    next(context, data);


  })

  // mais ce putin de done veut pas se declencher qd tt est fini...... et Le 'yo' apprait en tt debut.
  .done(function(){return listegocar})
  .log(console.log)
  .error(console.log)
  .debug(console.log)



}


exports.test=test;
